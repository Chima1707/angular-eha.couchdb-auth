!function(){"use strict";function a(a,b,c,d,e,f){function g(){return d.when(b.all("_session").customGET())}function h(a){return d.when(b.all("_session").customPOST({name:a.username,password:a.password})).then(s).then(function(a){return console.log("GOT USER"),g().then(function(){return a})}).then(function(a){return a&&a.ok?(u.$broadcast("authenticationStateChange"),c.log("couchdb:login:success",a),a):(c.log("couchdb:login:failure:unknown"),d.reject(new Error))})["catch"](function(a){return 401===a.status?(c.log("couchdb:login:failure:invalid-credentials",a),d.reject(new Error("Invalid Credentials"))):(c.log("couchdb:login:failure:unknown",a),d.reject(new Error(a)))})}function i(){return t=null,e.removeItem("user")}function j(a){return e.setItem("user",a)}function k(){return e.getItem("user")}function l(){return d.when(b.all("_session").remove()).then(i)["finally"](function(){u.$broadcast("authenticationStateChange")})}function m(a){return a.token&&a.password?d.when(b.all("reset-password").customPOST({token:a.token,password:a.password})):a.email?d.when(b.all("reset-password").customPOST({email:a.email,callbackUrl:"http://localhost:5000/#/reset-password"})):void 0}function n(){return d.reject("NOT_IMPLEMENTED")}function o(){return d.reject("NOT_IMPLEMENTED")}function p(){return d.reject("NOT_IMPLEMENTED")}function q(a){return a.hasRole=function(a){return this.roles.indexOf(a)>-1},a.isAdmin=function(){return this.hasRole("_admin")},a}function r(){return t?d.when(q(t)):k().then(function(a){return a?(t=a,q(a)):d.reject("User not found")}).then(function(a){return g().then(function(){return a})})["catch"](function(a){return console.log(a),d.reject(a)})}function s(a){return a?(a=a.plain(),t={name:a.name,roles:a.roles,bearerToken:a.bearerToken},j(a)):void d.reject("No user found")}var t,u=f.$new(!0);return u.$on("unauthorized",function(){i()}),{signIn:h,signOut:l,resetPassword:m,accounts:{add:n,update:o,remove:p},getSession:g,getCurrentUser:r,on:u.$on.bind(u),trigger:u.$broadcast.bind(u)}}var b=angular.module("eha.couchdb-auth.auth.service",["restangular","LocalForageModule","ngCookies"]);b.provider("ehaCouchDbAuthService",["$localForageProvider","ehaCouchDbAuthHttpInterceptorProvider","$httpProvider",function(b,c,d){var e={localStorageNamespace:"eha",localStorageStoreName:"auth"};this.config=function(a){e=angular.extend(e,a),b.config({name:e.localStorageNamespace,storeName:e.localStorageStoreName}),a.interceptor&&(c.config({url:a.url,hosts:a.interceptor.hosts}),d.interceptors.push("ehaCouchDbAuthHttpInterceptor"))},this.requireAdminUser=function(a,b){return a.getCurrentUser().then(function(c){return c&&!c.isAdmin()?(a.trigger("unauthorized"),b.reject("unauthorized")):c})["catch"](function(){return a.trigger("unauthenticated"),b.reject("unauthenticated")})},this.requireAuthenticatedUser=function(a,b){return a.getCurrentUser().then(function(a){return a})["catch"](function(){return a.trigger("unauthenticated"),b.reject("unauthenticated")})},this.$get=["Restangular","$log","$q","$localForage","$rootScope",function(b,c,d,f,g){var h=b.withConfig(function(a){a.setBaseUrl(e.url),e.defaultHttpFields&&a.setDefaultHttpFields(e.defaultHttpFields)});return new a(e,h,c,d,f,g)}]}]),"undefined"!=typeof module&&module.exports&&(module.exports=b)}(),function(){"use strict";function a(a,b){function c(b){var c=a.hosts.filter(function(a){return b.indexOf(a)>-1});return!!c.length}var d=b.get("$q"),e=b.get("$log");return{request:function(a){if(c(a.url)){var f=b.get("ehaCouchDbAuthService");return f.getCurrentUser().then(function(b){return b&&b.bearerToken&&(a.headers.Authorization="Bearer "+b.bearerToken),a})["catch"](function(b){return e.error(b),a})}return d.when(a)},responseError:function(a){if(401===a.status&&c(a.config.url)){var e=b.get("ehaCouchDbAuthService");e.trigger("unauthorized")}return d.reject(a)}}}var b=angular.module("eha.couchdb-auth.http-interceptor",[]);b.provider("ehaCouchDbAuthHttpInterceptor",function(){var b={};this.config=function(a){b=a},this.$get=["$injector",function(c){return new a(b,c)}]}),"undefined"!=typeof module&&module.exports&&(module.exports=b)}(),angular.module("eha.couchdb-auth.show-authenticated.directive",[]).directive("ehaShowAuthenticated",["ehaCouchDbAuthService","$animate",function(a,b){var c="ng-hide",d="ng-hide-animate";return{restrict:"A",link:function(e,f){function g(){a.getCurrentUser().then(function(){b.removeClass(f,c,{tempClasses:d})})["catch"](function(){b.addClass(f,c,{tempClasses:d})})}f.addClass("ng-hide"),g(),a.on("authenticationStateChange",g)}}}]),function(){"use strict";var a=angular.module("eha.couchdb-auth",["eha.couchdb-auth.http-interceptor","eha.couchdb-auth.auth.service","eha.couchdb-auth.show-authenticated.directive"]);"undefined"!=typeof module&&module.exports&&(module.exports=a)}();